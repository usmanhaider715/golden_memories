<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Album - Golden Memories</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/js/app.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}</style>
</head>
<body class="bg-gray-100 min-h-screen">
  <nav class="bg-blue-600 text-white p-4">
    <div class="container mx-auto flex justify-between items-center">
      <a href="/dashboard" class="flex items-center">
        <img src="/logo.png" alt="Golden Memories" class="h-8 w-auto cursor-pointer hover:opacity-80 transition-opacity" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
        <h1 class="text-xl font-bold hidden">Golden Memories</h1>
      </a>
      <div class="flex items-center gap-4">
        <div class="relative">
          <button id="notificationsBtn" class="relative p-2 hover:bg-blue-700 rounded">
            üîî
            <span id="notificationBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
          </button>
          <div id="notificationsDropdown" class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg border hidden z-50">
            <div class="p-3 border-b">
              <h3 class="font-semibold text-gray-800">Notifications</h3>
            </div>
            <div id="notificationsList" class="max-h-64 overflow-y-auto">
              <div class="p-3 text-gray-500 text-center">No notifications</div>
            </div>
          </div>
        </div>
        <a href="/dashboard" class="text-white hover:underline">Dashboard</a>
        <a href="/profile" class="text-white hover:underline">Profile</a>
        <a href="/auth/logout" class="text-white hover:underline">Logout</a>
      </div>
    </div>
  </nav>
  
  <div class="container mx-auto p-4">
    <div class="bg-white rounded-lg shadow-lg p-6">
      <div class="flex justify-between items-start mb-6">
        <div>
          <h1 id="albumTitle" class="text-3xl font-bold text-gray-800 mb-2"></h1>
          <p id="albumDescription" class="text-gray-600"></p>
          <p id="albumDate" class="text-sm text-gray-500 mt-2"></p>
        </div>
        <button onclick="history.back()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded">‚Üê Back</button>
      </div>
      <div id="passwordGate" class="mb-6 hidden">
        <div class="bg-amber-50 border border-amber-200 p-4 rounded">
          <p class="text-amber-700 mb-2">This album is protected. Enter password to view.</p>
          <div class="flex gap-2">
            <input id="albumPasswordInput" type="password" class="border rounded p-2 flex-1" placeholder="Album password">
            <button id="albumPasswordSubmit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Unlock</button>
          </div>
          <p id="albumPasswordError" class="text-red-600 text-sm mt-2 hidden">Incorrect password. Try again.</p>
        </div>
      </div>
      
      <div id="mediaGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        <!-- Media items will be loaded here -->
      </div>
      
      <div id="noMedia" class="text-center text-gray-500 py-8 hidden">
        <p>No media in this album yet.</p>
      </div>
    </div>
  </div>

  <!-- Full-screen image viewer -->
  <div id="imageViewer" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50">
    <div class="flex items-center justify-center h-full">
      <div class="relative max-w-4xl max-h-full">
        <button id="closeViewer" class="absolute top-4 right-4 text-white text-2xl hover:text-gray-300 z-10">‚úï</button>
        <button id="prevImage" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white text-2xl hover:text-gray-300 z-10">‚Äπ</button>
        <button id="nextImage" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white text-2xl hover:text-gray-300 z-10">‚Ä∫</button>
        
        <div class="flex items-center justify-center">
          <img id="viewerImage" class="max-w-full max-h-full object-contain" alt="">
          <video id="viewerVideo" class="max-w-full max-h-full object-contain hidden" controls></video>
        </div>
        
        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-4">
          <button id="likeBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded">‚ù§Ô∏è Like</button>
          <button id="unlikeBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded">üíî Unlike</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentAlbum = null;
    let currentMedia = [];
    let currentIndex = 0;

    // Load album data
    async function loadAlbum() {
      const albumId = window.location.pathname.split('/').pop();
      try {
        const res = await fetch(`/search/album/${albumId}/media`, { credentials: 'same-origin' });
        if (res.status === 403) {
          const data = await res.json();
          if (data && data.requiresPassword) {
            document.getElementById('passwordGate').classList.remove('hidden');
            return;
          }
          throw new Error('Access denied');
        }
        if (!res.ok) throw new Error('Failed to load album');
        
        const data = await res.json();
        currentAlbum = data.album;
        currentMedia = data.media;
        
        document.getElementById('albumTitle').textContent = currentAlbum.title;
        document.getElementById('albumDescription').textContent = currentAlbum.description || 'No description';
        document.getElementById('albumDate').textContent = `Created: ${new Date(currentAlbum.upload_date).toLocaleDateString()}`;
        
        renderMedia();
      } catch (err) {
        console.error('Error loading album:', err);
        document.getElementById('noMedia').classList.remove('hidden');
      }
    }

    // Password submit
    document.getElementById('albumPasswordSubmit').addEventListener('click', async () => {
      const pwd = document.getElementById('albumPasswordInput').value;
      const albumId = window.location.pathname.split('/').pop();
      const r = await fetch(`/search/album/${albumId}/access`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify({ password: pwd }) });
      if (r.ok) {
        document.getElementById('passwordGate').classList.add('hidden');
        loadAlbum();
      } else {
        document.getElementById('albumPasswordError').classList.remove('hidden');
      }
    });

    function renderMedia() {
      const grid = document.getElementById('mediaGrid');
      const noMedia = document.getElementById('noMedia');
      
      if (currentMedia.length === 0) {
        grid.classList.add('hidden');
        noMedia.classList.remove('hidden');
        return;
      }
      
      grid.classList.remove('hidden');
      noMedia.classList.add('hidden');
      
      grid.innerHTML = currentMedia.map((media, index) => `
        <div class="aspect-square bg-gray-200 rounded-lg overflow-hidden cursor-pointer hover:shadow-lg transition-shadow" onclick="openImageViewer(${index})">
          ${media.type === 'image' 
            ? `<img src="${media.url}" alt="Media ${index + 1}" class="w-full h-full object-cover">`
            : `<video src="${media.url}" class="w-full h-full object-cover" muted></video>`
          }
        </div>
      `).join('');
    }

    function openImageViewer(index) {
      currentIndex = index;
      const media = currentMedia[index];
      const viewer = document.getElementById('imageViewer');
      const img = document.getElementById('viewerImage');
      const video = document.getElementById('viewerVideo');
      
      if (media.type === 'image') {
        img.src = media.url;
        img.classList.remove('hidden');
        video.classList.add('hidden');
      } else {
        video.src = media.url;
        video.classList.remove('hidden');
        img.classList.add('hidden');
      }
      
      viewer.classList.remove('hidden');
      updateNavigationButtons();
    }

    function updateNavigationButtons() {
      const prevBtn = document.getElementById('prevImage');
      const nextBtn = document.getElementById('nextImage');
      
      prevBtn.style.display = currentIndex > 0 ? 'block' : 'none';
      nextBtn.style.display = currentIndex < currentMedia.length - 1 ? 'block' : 'none';
    }

    function showPrevImage() {
      if (currentIndex > 0) {
        openImageViewer(currentIndex - 1);
      }
    }

    function showNextImage() {
      if (currentIndex < currentMedia.length - 1) {
        openImageViewer(currentIndex + 1);
      }
    }

    function closeImageViewer() {
      document.getElementById('imageViewer').classList.add('hidden');
    }

    // Event listeners
    document.getElementById('closeViewer').addEventListener('click', closeImageViewer);
    document.getElementById('prevImage').addEventListener('click', showPrevImage);
    document.getElementById('nextImage').addEventListener('click', showNextImage);
    document.getElementById('imageViewer').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeImageViewer();
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('imageViewer').classList.contains('hidden')) {
        if (e.key === 'Escape') closeImageViewer();
        if (e.key === 'ArrowLeft') showPrevImage();
        if (e.key === 'ArrowRight') showNextImage();
      }
    });

    // Like/Unlike functionality
    document.getElementById('likeBtn').addEventListener('click', async () => {
      const mediaId = currentMedia[currentIndex].id;
      try {
        const res = await fetch(`/search/media/${mediaId}/like`, { method: 'POST', credentials: 'same-origin' });
        if (res.ok) {
          alert('Liked!');
          loadNotifications(); // Refresh notifications
        }
      } catch (err) {
        alert('Failed to like');
      }
    });

    document.getElementById('unlikeBtn').addEventListener('click', async () => {
      const mediaId = currentMedia[currentIndex].id;
      try {
        const res = await fetch(`/search/media/${mediaId}/unlike`, { method: 'POST', credentials: 'same-origin' });
        if (res.ok) {
          alert('Unliked!');
        }
      } catch (err) {
        alert('Failed to unlike');
      }
    });

    // Notifications
    async function loadNotifications() {
      try {
        const res = await fetch('/search/notifications', { credentials: 'same-origin' });
        if (!res.ok) return;
        
        const notifications = await res.json();
        const badge = document.getElementById('notificationBadge');
        const list = document.getElementById('notificationsList');
        
        if (notifications.length > 0) {
          badge.textContent = notifications.length;
          badge.classList.remove('hidden');
          list.innerHTML = notifications.map(n => `
            <div class="p-3 border-b hover:bg-gray-50">
              <p class="text-sm text-gray-800">${n.message}</p>
              <p class="text-xs text-gray-500 mt-1">${new Date(n.created_at).toLocaleString()}</p>
            </div>
          `).join('');
        } else {
          badge.classList.add('hidden');
          list.innerHTML = '<div class="p-3 text-gray-500 text-center">No notifications</div>';
        }
      } catch (err) {
        console.error('Error loading notifications:', err);
      }
    }

    // Toggle notifications dropdown
    document.getElementById('notificationsBtn').addEventListener('click', () => {
      const dropdown = document.getElementById('notificationsDropdown');
      dropdown.classList.toggle('hidden');
      if (!dropdown.classList.contains('hidden')) {
        loadNotifications();
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const btn = document.getElementById('notificationsBtn');
      const dropdown = document.getElementById('notificationsDropdown');
      if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
    });

    // Load album on page load
    loadAlbum();
  </script>
</body>
</html>
